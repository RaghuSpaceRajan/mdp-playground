
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mdp_playground.config_processor.config_processor &#8212; MDP Playground 0.0.1 documentation</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      
      <h1 class="site-logo" id="site-title">MDP Playground 0.0.1 documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../_autosummary/mdp_playground.html">
   mdp_playground
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/mdp_playground.analysis.html">
     mdp_playground.analysis
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.analysis.analysis.html">
       mdp_playground.analysis.analysis
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
      <label for="toctree-checkbox-3">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.analysis.analysis.MDPP_Analysis.html">
         mdp_playground.analysis.analysis.MDPP_Analysis
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.analysis.radar_chart.html">
       mdp_playground.analysis.radar_chart
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
      <label for="toctree-checkbox-4">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.analysis.radar_chart.radar_factory.html">
         mdp_playground.analysis.radar_chart.radar_factory
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../_autosummary/mdp_playground.config_processor.html">
     mdp_playground.config_processor
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/mdp_playground.envs.html">
     mdp_playground.envs
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.envs.gym_env_wrapper.html">
       mdp_playground.envs.gym_env_wrapper
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
      <label for="toctree-checkbox-6">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.envs.gym_env_wrapper.GymEnvWrapper.html">
         mdp_playground.envs.gym_env_wrapper.GymEnvWrapper
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.envs.mujoco_env_wrapper.html">
       mdp_playground.envs.mujoco_env_wrapper
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
      <label for="toctree-checkbox-7">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.envs.mujoco_env_wrapper.get_mujoco_wrapper.html">
         mdp_playground.envs.mujoco_env_wrapper.get_mujoco_wrapper
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.envs.rl_toy_env.html">
       mdp_playground.envs.rl_toy_env
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
      <label for="toctree-checkbox-8">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.envs.rl_toy_env.dist_of_pt_from_line.html">
         mdp_playground.envs.rl_toy_env.dist_of_pt_from_line
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.envs.rl_toy_env.list_to_float_np_array.html">
         mdp_playground.envs.rl_toy_env.list_to_float_np_array
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.envs.rl_toy_env.RLToyEnv.html">
         mdp_playground.envs.rl_toy_env.RLToyEnv
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/mdp_playground.scripts.html">
     mdp_playground.scripts
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.scripts.run_experiments.html">
       mdp_playground.scripts.run_experiments
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
      <label for="toctree-checkbox-10">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.scripts.run_experiments.cli.html">
         mdp_playground.scripts.run_experiments.cli
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.scripts.run_experiments.main.html">
         mdp_playground.scripts.run_experiments.main
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.html">
     mdp_playground.spaces
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
    <label for="toctree-checkbox-11">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.box_extended.html">
       mdp_playground.spaces.box_extended
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
      <label for="toctree-checkbox-12">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.box_extended.BoxExtended.html">
         mdp_playground.spaces.box_extended.BoxExtended
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.discrete_extended.html">
       mdp_playground.spaces.discrete_extended
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
      <label for="toctree-checkbox-13">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.discrete_extended.DiscreteExtended.html">
         mdp_playground.spaces.discrete_extended.DiscreteExtended
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.image_continuous.html">
       mdp_playground.spaces.image_continuous
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
      <label for="toctree-checkbox-14">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.image_continuous.ImageContinuous.html">
         mdp_playground.spaces.image_continuous.ImageContinuous
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.image_multi_discrete.html">
       mdp_playground.spaces.image_multi_discrete
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
      <label for="toctree-checkbox-15">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.image_multi_discrete.ImageMultiDiscrete.html">
         mdp_playground.spaces.image_multi_discrete.ImageMultiDiscrete
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.multi_discrete_extended.html">
       mdp_playground.spaces.multi_discrete_extended
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
      <label for="toctree-checkbox-16">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.multi_discrete_extended.MultiDiscreteExtended.html">
         mdp_playground.spaces.multi_discrete_extended.MultiDiscreteExtended
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.test_image_continuous.html">
       mdp_playground.spaces.test_image_continuous
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
      <label for="toctree-checkbox-17">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.test_image_continuous.TestImageContinuous.html">
         mdp_playground.spaces.test_image_continuous.TestImageContinuous
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.test_image_multi_discrete.html">
       mdp_playground.spaces.test_image_multi_discrete
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/>
      <label for="toctree-checkbox-18">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.test_image_multi_discrete.TestImageMultiDiscrete.html">
         mdp_playground.spaces.test_image_multi_discrete.TestImageMultiDiscrete
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.tuple_extended.html">
       mdp_playground.spaces.tuple_extended
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/>
      <label for="toctree-checkbox-19">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../_autosummary/mdp_playground.spaces.tuple_extended.TupleExtended.html">
         mdp_playground.spaces.tuple_extended.TupleExtended
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <h1>Source code for mdp_playground.config_processor.config_processor</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">ray.tune.registry</span> <span class="kn">import</span> <span class="n">register_env</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>

<span class="n">mujoco_envs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;HalfCheetahWrapper-v3&quot;</span><span class="p">,</span> <span class="s2">&quot;HopperWrapper-v3&quot;</span><span class="p">,</span> <span class="s2">&quot;PusherWrapper-v2&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;ReacherWrapper-v2&quot;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">mdp_playground</span>
<span class="kn">from</span> <span class="nn">mdp_playground.envs</span> <span class="kn">import</span> <span class="n">RLToyEnv</span>
<span class="kn">from</span> <span class="nn">ray.tune.registry</span> <span class="kn">import</span> <span class="n">register_env</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>


<span class="kn">from</span> <span class="nn">ray.rllib.models.preprocessors</span> <span class="kn">import</span> <span class="n">OneHotPreprocessor</span>
<span class="kn">from</span> <span class="nn">ray.rllib.models</span> <span class="kn">import</span> <span class="n">ModelCatalog</span>
<span class="n">ModelCatalog</span><span class="o">.</span><span class="n">register_custom_preprocessor</span><span class="p">(</span><span class="s2">&quot;ohe&quot;</span><span class="p">,</span> <span class="n">OneHotPreprocessor</span><span class="p">)</span>


<span class="c1"># def init_ray(log_level=None, tmp_dir=None, include_webui=None,</span>
<span class="c1">#              object_store_memory=int(2e9),</span>
<span class="c1">#              redis_max_memory=int(1e9), local_mode=False):</span>
<div class="viewcode-block" id="init_ray"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.init_ray.html#mdp_playground.config_processor.config_processor.init_ray">[docs]</a><span class="k">def</span> <span class="nf">init_ray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">ray</span>
    <span class="k">if</span> <span class="n">ray</span><span class="o">.</span><span class="n">__version__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>  <span class="c1"># new version 1.0 API</span>
        <span class="k">if</span> <span class="s2">&quot;redis_max_memory&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;redis_max_memory&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;redis_max_memory&quot;</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_redis_max_memory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="s2">&quot;tmp_dir&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tmp_dir&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tmp_dir&quot;</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_temp_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;tmp_dir&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tmp_dir&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tmp_dir&quot;</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;temp_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">if</span> <span class="s2">&quot;log_level&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;log_level&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;log_level&quot;</span><span class="p">]</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;logging_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_configs"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.process_configs.html#mdp_playground.config_processor.config_processor.process_configs">[docs]</a><span class="k">def</span> <span class="nf">process_configs</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">stats_file_prefix</span><span class="p">,</span> <span class="n">config_num</span><span class="p">,</span> <span class="n">log_level</span><span class="p">,</span>
                    <span class="n">framework</span><span class="o">=</span><span class="s1">&#39;ray&#39;</span><span class="p">,</span> <span class="n">framework_dir</span><span class="o">=</span><span class="s1">&#39;/tmp/ray&#39;</span><span class="p">):</span>
    <span class="n">config_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">config_file_path</span><span class="p">)</span> <span class="c1"># #hack</span>
    <span class="kn">import</span> <span class="nn">importlib</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">config_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of seeds for environment:&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">num_seeds</span><span class="p">)</span>


    <span class="c1"># #hacks needed to setup Ray callbacks below</span>
    <span class="c1"># #hack because these need to be read in on_train_result and trying to read</span>
    <span class="c1"># config there raises an error because it&#39;s been imported from a Python</span>
    <span class="c1"># module and I think they try to reload the module there.</span>
    <span class="n">variable_configs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;var_configs&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="n">variable_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">var_configs</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;random_configs&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="n">variable_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">random_configs</span><span class="p">))</span>
    <span class="k">if</span> <span class="s1">&#39;sobol_configs&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="n">variable_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sobol_configs</span><span class="p">))</span>

    <span class="c1"># overwrite = False because the keys in different modes of config generation</span>
    <span class="c1"># need to be disjoint</span>
    <span class="n">variable_configs_deepcopy</span> <span class="o">=</span> <span class="n">deepmerge_multiple_dicts</span><span class="p">(</span><span class="o">*</span><span class="n">variable_configs</span><span class="p">,</span>
                                            <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;timesteps_total&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="n">hacky_timesteps_total</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">timesteps_total</span> <span class="c1">#hack</span>

    <span class="n">config_algorithm</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">algorithm</span> <span class="c1">#hack</span>
    <span class="c1"># sys.exit(0)</span>

    <span class="n">columns_to_write</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">config_type</span><span class="p">,</span> <span class="n">config_dict</span> <span class="ow">in</span> <span class="n">variable_configs_deepcopy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
            <span class="n">columns_to_write</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="n">stats_file_name</span> <span class="o">=</span> <span class="n">stats_file_prefix</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>

    <span class="n">init_stats_file</span><span class="p">(</span><span class="n">stats_file_name</span><span class="p">,</span> <span class="n">columns_to_write</span><span class="p">)</span>

    <span class="c1"># Ray specific setup:</span>
    <span class="k">if</span> <span class="n">framework</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ray&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">tune</span>
        <span class="n">setup_ray</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_num</span><span class="p">,</span> <span class="n">log_level</span><span class="p">,</span> <span class="n">framework_dir</span><span class="p">)</span>
        <span class="n">on_train_result</span><span class="p">,</span> <span class="n">on_episode_end</span> <span class="o">=</span> <span class="n">setup_ray_callbacks</span><span class="p">(</span><span class="n">stats_file_prefix</span><span class="p">,</span> <span class="n">variable_configs_deepcopy</span><span class="p">,</span> <span class="n">hacky_timesteps_total</span><span class="p">,</span> <span class="n">config_algorithm</span><span class="p">)</span>

        <span class="c1">#default Define default config which gets overwritten with config in config.py file if present.</span>
        <span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;callbacks&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">#                 &quot;on_episode_start&quot;: tune.function(on_episode_start),</span>
                <span class="c1"># &quot;on_episode_step&quot;: tune.function(on_episode_step),</span>
                <span class="s2">&quot;on_episode_end&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">on_episode_end</span><span class="p">),</span>
    <span class="c1">#                 &quot;on_sample_end&quot;: tune.function(on_sample_end),</span>
                <span class="s2">&quot;on_train_result&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">on_train_result</span><span class="p">),</span>
    <span class="c1">#                 &quot;on_postprocess_traj&quot;: tune.function(on_postprocess_traj),</span>
                    <span class="p">},</span>
            <span class="c1"># &quot;log_level&quot;: &#39;WARN&#39;,</span>
        <span class="p">}</span>

    <span class="c1"># Stable Baselines specific setup:</span>
    <span class="k">elif</span> <span class="n">framework</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;stable_baselines&#39;</span><span class="p">:</span>
        <span class="o">...</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Framework passed was not a valid option. It was: &quot;</span> \
        <span class="o">+</span> <span class="n">framework</span> <span class="o">+</span> <span class="s2">&quot;. Available options are: ray and stable_baselines.&quot;</span><span class="p">)</span>


    <span class="n">varying_configs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">separate_var_configs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># ###IMP Currently num_configs has to be equal for all 3 cases below:</span>
    <span class="c1"># grid (i.e. var), random and sobol #TODO Not sure how to solve this #config</span>
    <span class="c1"># setup problem. Could take Cartesian product of all 3 but that may lead to</span>
    <span class="c1"># too many configs and Cartesian product of dicts is a pain.</span>
    <span class="k">if</span> <span class="s1">&#39;var_configs&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="n">separate_var_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_list_of_varying_configs</span><span class="p">(</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">var_configs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="s1">&#39;sobol_configs&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="n">separate_var_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_list_of_varying_configs</span><span class="p">(</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">sobol_configs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sobol&#39;</span><span class="p">,</span>
                            <span class="n">num_configs</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">num_configs</span><span class="p">))</span>
    <span class="k">if</span> <span class="s1">&#39;random_configs&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="n">separate_var_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_list_of_varying_configs</span><span class="p">(</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">random_configs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">,</span>
                            <span class="n">num_configs</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">num_configs</span><span class="p">))</span>
    <span class="c1"># print(&quot;VARYING_CONFIGS:&quot;, varying_configs)</span>

    <span class="n">num_configs_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">separate_var_configs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> \
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">separate_var_configs</span><span class="p">))])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_configs_</span><span class="p">):</span>
        <span class="n">to_combine</span> <span class="o">=</span> <span class="p">[</span><span class="n">separate_var_configs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> \
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">separate_var_configs</span><span class="p">))]</span>
        <span class="c1"># overwrite = False because the keys in different modes of</span>
        <span class="c1"># config generation need to be disjoint</span>
        <span class="n">varying_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepmerge_multiple_dicts</span><span class="p">(</span><span class="o">*</span><span class="n">to_combine</span><span class="p">,</span>
                                                <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


    <span class="c1"># varying_configs is a list of dict of dicts with a specific structure.</span>
    <span class="n">final_configs</span> <span class="o">=</span> <span class="n">combined_processing</span><span class="p">(</span><span class="n">default_config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">env_config</span><span class="p">,</span>
                                    <span class="n">config</span><span class="o">.</span><span class="n">agent_config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">model_config</span><span class="p">,</span>
                                    <span class="n">config</span><span class="o">.</span><span class="n">eval_config</span><span class="p">,</span> <span class="n">varying_configs</span><span class="o">=</span><span class="n">varying_configs</span><span class="p">,</span> <span class="n">framework</span><span class="o">=</span><span class="n">framework</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="n">final_configs</span></div>


<div class="viewcode-block" id="setup_ray"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.setup_ray.html#mdp_playground.config_processor.config_processor.setup_ray">[docs]</a><span class="k">def</span> <span class="nf">setup_ray</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_num</span><span class="p">,</span> <span class="n">log_level</span><span class="p">,</span> <span class="n">framework_dir</span><span class="p">):</span>
    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">framework_dir</span> <span class="o">+</span> <span class="s1">&#39;/tmp_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_num</span><span class="p">)</span>
    <span class="c1"># import ray</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;DQN&#39;</span><span class="p">:</span> <span class="c1">#hack</span>
        <span class="n">init_ray</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="c1"># ray.init(object_store_memory=int(2e9), redis_max_memory=int(1e9),</span>
        <span class="c1">#          temp_dir=tmp_dir,</span>
        <span class="c1">#          logging_level=log_level,</span>
        <span class="c1">#          # local_mode=True,</span>
        <span class="c1">#          # webui_host=&#39;0.0.0.0&#39;); logging_level=logging.INFO,</span>
        <span class="c1">#          )</span>
        <span class="c1"># ray.init(object_store_memory=int(2e9), redis_max_memory=int(1e9), local_mode=True, plasma_directory=&#39;/tmp&#39;) #, memory=int(8e9), local_mode=True # local_mode (bool): If true, the code will be executed serially. This is useful for debugging. # when true on_train_result and on_episode_end operate in the same current directory as the script. A3C is crashing in local mode, so didn&#39;t use it and had to work around by giving full path + filename in stats_file_name.; also has argument driver_object_store_memory=, plasma_directory=&#39;/tmp&#39;</span>
    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;A3C&#39;</span><span class="p">:</span> <span class="c1">#hack</span>
        <span class="n">init_ray</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="c1"># ray.init(object_store_memory=int(2e9), redis_max_memory=int(1e9),</span>
        <span class="c1">#          temp_dir=tmp_dir,</span>
        <span class="c1">#          logging_level=log_level,</span>
        <span class="c1">#          # local_mode=True,</span>
        <span class="c1">#          # webui_host=&#39;0.0.0.0&#39;); logging_level=logging.INFO,</span>
        <span class="c1">#          )        # ray.init(object_store_memory=int(2e9), redis_max_memory=int(1e9), local_mode=True, plasma_directory=&#39;/tmp&#39;)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">init_ray</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">local_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

        <span class="c1"># ray.init(object_store_memory=int(2e9), redis_max_memory=int(1e9),</span>
        <span class="c1">#          temp_dir=tmp_dir,</span>
        <span class="c1">#          logging_level=log_level,</span>
        <span class="c1">#          local_mode=True,</span>
        <span class="c1">#          # webui_host=&#39;0.0.0.0&#39;); logging_level=logging.INFO,</span>
        <span class="c1">#          )</span>

<div class="viewcode-block" id="init_stats_file"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.init_stats_file.html#mdp_playground.config_processor.config_processor.init_stats_file">[docs]</a><span class="k">def</span> <span class="nf">init_stats_file</span><span class="p">(</span><span class="n">stats_file_name</span><span class="p">,</span> <span class="n">columns_to_write</span><span class="p">):</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">stats_file_name</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1">#hardcoded</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# training_iteration, algorithm, &#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns_to_write</span><span class="p">:</span>
            <span class="c1"># if config_type == &quot;agent&quot;:</span>
            <span class="c1">#     if config_algorithm == &#39;SAC&#39; and key == &quot;critic_learning_rate&quot;:</span>
            <span class="c1">#         real_key = &quot;lr&quot; #hack due to Ray&#39;s weird ConfigSpaces</span>
            <span class="c1">#         fout.write(real_key + &#39;, &#39;)</span>
            <span class="c1">#     elif config_algorithm == &#39;SAC&#39; and key == &quot;fcnet_hiddens&quot;:</span>
            <span class="c1">#         #hack due to Ray&#39;s weird ConfigSpaces</span>
            <span class="c1">#         fout.write(&#39;fcnet_hiddens&#39; + &#39;, &#39;)</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         fout.write(key + &#39;, &#39;)</span>
            <span class="c1"># else:</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">column</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;timesteps_total, episode_reward_mean, episode_len_mean</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># , mem_used_mb</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="setup_ray_callbacks"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.setup_ray_callbacks.html#mdp_playground.config_processor.config_processor.setup_ray_callbacks">[docs]</a><span class="k">def</span> <span class="nf">setup_ray_callbacks</span><span class="p">(</span><span class="n">stats_file_prefix</span><span class="p">,</span> <span class="n">variable_configs_deepcopy</span><span class="p">,</span> <span class="n">hacky_timesteps_total</span><span class="p">,</span> <span class="n">config_algorithm</span><span class="p">):</span>
    <span class="c1"># Setup Ray callbacks</span>
    <span class="c1"># Ray callback to write training stats to CSV file at end of every training iteration</span>
    <span class="c1">#hack Didn&#39;t know how to move this function to config. It requires the filename which _has_ to be possible to set in run_experiments.py. Had to take care of stats_file_prefix, variable_configs_deepcopy, hacky_timesteps_total, config_algorithm; and had to initialise file writing in here (config_processor).</span>
    <span class="k">def</span> <span class="nf">on_train_result</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
        <span class="n">training_iteration</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;training_iteration&quot;</span><span class="p">]</span>
        <span class="c1"># algorithm = info[&quot;trainer&quot;]._name</span>

        <span class="c1"># Writes every iteration, would slow things down. #hack</span>
        <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">stats_file_prefix</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1">#hardcoded</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">training_iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">config_algorithm</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">config_type</span><span class="p">,</span> <span class="n">config_dict</span> <span class="ow">in</span> <span class="n">variable_configs_deepcopy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">config_type</span> <span class="o">==</span> <span class="s2">&quot;env&quot;</span><span class="p">:</span>
                    <span class="n">field_val</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="n">str_to_write</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field_val</span>
                    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">field_val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="n">str_to_write</span> <span class="o">=</span> <span class="s2">&quot;[&quot;</span>
                        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">field_val</span><span class="p">:</span>
                            <span class="c1"># print(key)</span>
                            <span class="n">str_to_write</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">elem</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                            <span class="n">str_to_write</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
                        <span class="n">str_to_write</span> <span class="o">+=</span> <span class="s2">&quot;]&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">str_to_write</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_val</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">str_to_write</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_to_write</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">config_type</span> <span class="o">==</span> <span class="s2">&quot;agent&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">config_algorithm</span> <span class="o">==</span> <span class="s1">&#39;SAC&#39;</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;critic_learning_rate&quot;</span><span class="p">:</span>
                        <span class="n">real_key</span> <span class="o">=</span> <span class="s2">&quot;lr&quot;</span> <span class="c1">#hack due to Ray&#39;s weird ConfigSpaces</span>
                        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s1">&#39;optimization&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">config_algorithm</span> <span class="o">==</span> <span class="s1">&#39;SAC&#39;</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;fcnet_hiddens&quot;</span><span class="p">:</span>
                        <span class="c1">#hack due to Ray&#39;s weird ConfigSpaces</span>
                        <span class="n">str_to_write</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;Q_model&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_to_write</span><span class="p">)</span>
                    <span class="c1"># elif config_algorithm == &#39;SAC&#39; and key == &quot;policy_model&quot;:</span>
                    <span class="c1">#     #hack due to Ray&#39;s weird ConfigSpaces</span>
                    <span class="c1">#     pass</span>
                        <span class="c1"># fout.write(str(info[&quot;result&quot;][&quot;config&quot;][key][&#39;fcnet_hiddens&#39;]).replace(&#39; &#39;, &#39;&#39;) + &#39; &#39;)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;exploration_fraction&quot;</span> <span class="ow">and</span> <span class="s2">&quot;exploration_fraction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;config&quot;</span><span class="p">]:</span> <span class="c1">#hack ray 0.7.3 will have exploration_fraction but not versions later than ~0.9</span>
                            <span class="n">field_val</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;exploration_config&quot;</span><span class="p">][</span><span class="s2">&quot;epsilon_timesteps&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">hacky_timesteps_total</span> <span class="c1"># convert to fraction to be similar to old exploration_fraction</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">field_val</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                        <span class="n">str_to_write</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field_val</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_val</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_val</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">str_to_write</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
                        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_to_write</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">config_type</span> <span class="o">==</span> <span class="s2">&quot;model&quot;</span><span class="p">:</span>
                    <span class="c1"># if key == &#39;conv_filters&#39;:</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="c1"># Write train stats</span>
        <span class="n">timesteps_total</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;timesteps_total&quot;</span><span class="p">]</span> <span class="c1"># also has episodes_total and training_iteration</span>
        <span class="n">episode_reward_mean</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;episode_reward_mean&quot;</span><span class="p">]</span> <span class="c1"># also has max and min</span>
        <span class="c1"># print(&quot;Custom_metrics: &quot;, info[&quot;result&quot;][&quot;step_reward_mean&quot;], info[&quot;result&quot;][&quot;step_reward_max&quot;], info[&quot;result&quot;][&quot;step_reward_min&quot;])</span>
        <span class="n">episode_len_mean</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;episode_len_mean&quot;</span><span class="p">]</span>


        <span class="c1"># ##TODO write CSV stats configs only once in each case, write runtime and memory, td_error - check tempoRL logs;</span>
        <span class="c1"># import os, psutil</span>
        <span class="c1"># mem_used_mb = psutil.Process(os.getpid()).memory_info().rss / 1024 ** 2</span>

        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">timesteps_total</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">episode_reward_mean</span> <span class="o">+</span>
                   <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">episode_len_mean</span> <span class="c1">#  + &#39; &#39; + &#39;%.2e&#39; % mem_used_mb</span>
                    <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># timesteps_total always HAS to be the 1st written: analysis.py depends on it</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>



        <span class="c1"># print(&quot;##### stats_file_name: &quot;, stats_file_name)</span>
        <span class="c1"># print(os.getcwd())</span>

        <span class="c1"># We did not manage to find an easy way to log evaluation stats for Ray without the following hack which demarcates the end of a training iteration in the evaluation stats file</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;evaluation_interval&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stats_file_eval</span> <span class="o">=</span> <span class="n">stats_file_prefix</span> <span class="o">+</span> <span class="s1">&#39;_eval.csv&#39;</span>
            <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">stats_file_eval</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1">#hardcoded</span>

            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#HACK STRING EVAL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;callback_ok&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>


    <span class="c1"># Ray callback to write evaluation stats to CSV file at end of every training iteration</span>
    <span class="c1"># on_episode_end is used because these results won&#39;t be available on_train_result</span>
    <span class="c1"># but only after every episode has ended during evaluation (evaluation phase is</span>
    <span class="c1"># checked for by using dummy_eval)</span>
    <span class="k">def</span> <span class="nf">on_episode_end</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;dummy_eval&quot;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_unwrapped</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="c1"># print(&quot;###on_episode_end info&quot;, info[&quot;env&quot;].get_unwrapped()[0].config[&quot;make_denser&quot;], info[&quot;episode&quot;].total_reward, info[&quot;episode&quot;].length) #, info[&quot;episode&quot;]._agent_reward_history)</span>
            <span class="n">reward_this_episode</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;episode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_reward</span>
            <span class="n">length_this_episode</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;episode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
            <span class="n">stats_file_eval</span> <span class="o">=</span> <span class="n">stats_file_prefix</span> <span class="o">+</span> <span class="s1">&#39;_eval.csv&#39;</span>
            <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">stats_file_eval</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="c1">#hardcoded</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">reward_this_episode</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">length_this_episode</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_episode_step</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
        <span class="n">episode</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;episode&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;step_reward&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">episode</span><span class="o">.</span><span class="n">custom_metrics</span><span class="p">:</span>
            <span class="n">episode</span><span class="o">.</span><span class="n">custom_metrics</span><span class="p">[</span><span class="s2">&quot;step_reward&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">step_reward</span> <span class="o">=</span>  <span class="n">episode</span><span class="o">.</span><span class="n">total_reward</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step_reward</span> <span class="o">=</span>  <span class="n">episode</span><span class="o">.</span><span class="n">total_reward</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">episode</span><span class="o">.</span><span class="n">custom_metrics</span><span class="p">[</span><span class="s2">&quot;step_reward&quot;</span><span class="p">])</span>
            <span class="n">episode</span><span class="o">.</span><span class="n">custom_metrics</span><span class="p">[</span><span class="s2">&quot;step_reward&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_reward</span><span class="p">)</span> <span class="c1"># This line</span>
            <span class="c1"># should not be executed the 1st time this function is called because</span>
            <span class="c1"># no step has actually taken place then (Ray 0.9.0)!!</span>
        <span class="c1"># episode.custom_metrics = {}</span>
        <span class="c1"># episode.user_data = {}</span>
        <span class="c1"># episode.hist_data = {}</span>
        <span class="c1"># Next 2 are the same, except 1st one is total episodic reward _per_ agent</span>
        <span class="c1"># episode.agent_rewards = defaultdict(float)</span>
        <span class="c1"># episode.total_reward += reward</span>
        <span class="c1"># only hack to get per step reward seems to be to store prev total_reward</span>
        <span class="c1"># and subtract it from that</span>
        <span class="c1"># episode._agent_reward_history[agent_id].append(reward)</span>

    <span class="k">return</span> <span class="n">on_train_result</span><span class="p">,</span> <span class="n">on_episode_end</span></div>

<div class="viewcode-block" id="get_list_of_varying_configs"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.get_list_of_varying_configs.html#mdp_playground.config_processor.config_processor.get_list_of_varying_configs">[docs]</a><span class="k">def</span> <span class="nf">get_list_of_varying_configs</span><span class="p">(</span><span class="n">var_configs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="n">num_configs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    var_configs: dict of dicts of lists as values</span>
<span class="sd">        A dict of dicts with lists as the leaf values to allow each</span>
<span class="sd">        configuration option to take multiple possible values.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
        <span class="n">varying_configs</span> <span class="o">=</span> <span class="n">get_grid_of_configs</span><span class="p">(</span><span class="n">var_configs</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
        <span class="n">varying_configs</span> <span class="o">=</span> <span class="n">get_random_configs</span><span class="p">(</span><span class="n">var_configs</span><span class="p">,</span> <span class="n">num_configs</span><span class="o">=</span><span class="n">num_configs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;sobol&#39;</span><span class="p">:</span>
        <span class="n">varying_configs</span> <span class="o">=</span> <span class="n">sobol_configs_from_config_dict</span><span class="p">(</span><span class="n">var_configs</span><span class="p">,</span> <span class="n">num_configs</span><span class="o">=</span><span class="n">num_configs</span><span class="p">)</span>


    <span class="n">list_of_configs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">enum_conf_1</span><span class="p">,</span> <span class="n">current_config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">varying_configs</span><span class="p">):</span>
        <span class="n">env_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="n">agent_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;agent&quot;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="k">for</span> <span class="n">config_type</span><span class="p">,</span> <span class="n">config_dict</span> <span class="ow">in</span> <span class="n">var_configs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
            <span class="c1"># if config_type == &quot;env_config&quot;: # There is a dummy seed in the env_config because it&#39;s not used in the environment. It implies a different seed for the agent on every launch as the seed for Ray is not being set here. I faced problems with Ray&#39;s seeding process.</span>
                <span class="k">if</span> <span class="n">config_type</span> <span class="o">==</span> <span class="s2">&quot;env&quot;</span><span class="p">:</span>
                    <span class="n">env_config</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_config</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">var_configs</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>

                <span class="k">elif</span> <span class="n">config_type</span> <span class="o">==</span> <span class="s2">&quot;agent&quot;</span><span class="p">:</span> <span class="c1">#hack All these are hacks to get around different limitations</span>
                    <span class="n">num_configs_done</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">var_configs</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]))</span>
                    <span class="n">agent_config</span><span class="p">[</span><span class="s2">&quot;agent&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_config</span><span class="p">[</span><span class="n">num_configs_done</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">var_configs</span><span class="p">[</span><span class="n">config_type</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>

                <span class="k">elif</span> <span class="n">config_type</span> <span class="o">==</span> <span class="s2">&quot;model&quot;</span><span class="p">:</span>
                    <span class="n">num_configs_done</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">var_configs</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]))</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">var_configs</span><span class="p">[</span><span class="s2">&quot;agent&quot;</span><span class="p">]))</span>
                    <span class="n">model_config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_config</span><span class="p">[</span><span class="n">num_configs_done</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">var_configs</span><span class="p">[</span><span class="n">config_type</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>

        <span class="n">combined_config</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">agent_config</span><span class="p">,</span> <span class="o">**</span><span class="n">model_config</span><span class="p">,</span> <span class="o">**</span><span class="n">env_config</span><span class="p">}</span>

        <span class="n">list_of_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_config</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">list_of_configs</span></div>


<div class="viewcode-block" id="get_grid_of_configs"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.get_grid_of_configs.html#mdp_playground.config_processor.config_processor.get_grid_of_configs">[docs]</a><span class="k">def</span> <span class="nf">get_grid_of_configs</span><span class="p">(</span><span class="n">var_configs</span><span class="p">):</span>
    <span class="n">value_tuples</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># #TODO Currently, the var_configs dict is nested, might want to make it</span>
    <span class="c1"># single level. However, the config dicts used in Ray are nested, so keep it</span>
    <span class="c1"># like this for now. Further, the 2nd level division chosen for configs</span>
    <span class="c1"># currently, i.e., env, agent, model is a bit arbitrary, but better like</span>
    <span class="c1"># this since it can be compliant with Ray and other frameworks and additional</span>
    <span class="c1"># processing can take place in framework_specific_processing() below.</span>
    <span class="k">for</span> <span class="n">config_type</span><span class="p">,</span> <span class="n">config_dict</span> <span class="ow">in</span> <span class="n">var_configs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">var_configs</span><span class="p">[</span><span class="n">config_type</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">,</span> <span class="s2">&quot;var_configs should be a dict of dicts with lists as the leaf values to allow each configuration option to take multiple possible values&quot;</span>
            <span class="n">value_tuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_configs</span><span class="p">[</span><span class="n">config_type</span><span class="p">][</span><span class="n">key</span><span class="p">])</span>

    <span class="kn">import</span> <span class="nn">itertools</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_tuples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cartesian_product_configs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Edge case, else it&#39;d become [()].</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cartesian_product_configs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">value_tuples</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total number of configs. to run:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cartesian_product_configs</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">cartesian_product_configs</span></div>

<div class="viewcode-block" id="get_random_configs"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.get_random_configs.html#mdp_playground.config_processor.config_processor.get_random_configs">[docs]</a><span class="k">def</span> <span class="nf">get_random_configs</span><span class="p">(</span><span class="n">var_configs</span><span class="p">,</span> <span class="n">num_configs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    var_configs: dict of dicts of strings or tuples as values</span>
<span class="sd">        A dict of dicts with strings or tuples as the leaf values which encode</span>
<span class="sd">        a ConfigSpace.</span>

<span class="sd">    #TODO Currently num_configs is fixed for each config_type (env, agent or</span>
<span class="sd">    model) for this and get_sobol_configs()</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">random_configs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">config_type</span><span class="p">,</span> <span class="n">config_dict</span> <span class="ow">in</span> <span class="n">var_configs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">create_config_space_from_config_dict</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Variable ConfigSpace:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
            <span class="n">random_configs</span> <span class="o">+=</span> <span class="n">cs</span><span class="o">.</span><span class="n">sample_configuration</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">num_configs</span><span class="p">)</span>
            <span class="c1"># print(&quot;type(random_configs):&quot;, type(random_configs))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">random_configs</span><span class="p">)):</span>
        <span class="c1"># if random_configs[i].get_dictionary()[&quot;train_batch_size&quot;] == 4 \</span>
        <span class="c1"># and random_configs[i].get_dictionary()[&quot;buffer_size&quot;] &lt; 33:</span>
        <span class="c1">#     print(&quot;Config:&quot;, i, &quot;train_batch_size, buffer_size:&quot;, random_configs[i].get_dictionary()[&quot;train_batch_size&quot;], random_configs[i].get_dictionary()[&quot;buffer_size&quot;])</span>
        <span class="n">random_configs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">random_configs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_dictionary</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="c1">#hack ####TODO Change run_experiments.py and here to directly pass whole config dict to run_experiments.py. Would need to replace in every config.py file.</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">random_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">random_configs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">random_configs</span></div>

<div class="viewcode-block" id="create_config_space_from_config_dict"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.create_config_space_from_config_dict.html#mdp_playground.config_processor.config_processor.create_config_space_from_config_dict">[docs]</a><span class="k">def</span> <span class="nf">create_config_space_from_config_dict</span><span class="p">(</span><span class="n">config_dict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">ConfigSpace</span> <span class="k">as</span> <span class="nn">CS</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">CS</span><span class="o">.</span><span class="n">ConfigurationSpace</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span> <span class="c1"># #seed #random</span>
    <span class="kn">import</span> <span class="nn">ConfigSpace.hyperparameters</span> <span class="k">as</span> <span class="nn">CSH</span>
    <span class="kn">import</span> <span class="nn">json</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;int&quot;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s2">&quot;log&quot;</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">add_hyperparameter</span><span class="p">(</span><span class="n">CSH</span><span class="o">.</span><span class="n">UniformIntegerHyperparameter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s2">&quot;float&quot;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s2">&quot;log&quot;</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">add_hyperparameter</span><span class="p">(</span><span class="n">CSH</span><span class="o">.</span><span class="n">UniformFloatHyperparameter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s2">&quot;cat&quot;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span> <span class="c1"># Seems faster than ast.literal_eval (See https://stackoverflow.com/questions/1894269/how-to-convert-string-representation-of-list-to-a-list)</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">add_hyperparameter</span><span class="p">(</span><span class="n">CSH</span><span class="o">.</span><span class="n">CategoricalHyperparameter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">choices</span><span class="p">))</span>
            <span class="c1"># print(type(CSH.CategoricalHyperparameter(name=key, choices=choices).choices[0]))</span>

    <span class="k">return</span> <span class="n">cs</span></div>

<div class="viewcode-block" id="sobol_configs_from_config_dict"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.sobol_configs_from_config_dict.html#mdp_playground.config_processor.config_processor.sobol_configs_from_config_dict">[docs]</a><span class="k">def</span> <span class="nf">sobol_configs_from_config_dict</span><span class="p">(</span><span class="n">var_configs</span><span class="p">,</span> <span class="n">num_configs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sobol_configs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">config_type</span><span class="p">,</span> <span class="n">config_dict</span> <span class="ow">in</span> <span class="n">var_configs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">num_dims</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span> <span class="c1"># i.e. a constant value</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># i.e. a variable value</span>
                <span class="n">num_dims</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating sobol sequence with &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_configs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; and &quot;</span> \
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_dims</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; dimensions:&quot;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">scipy.optimize._shgo_lib.sobol_seq</span> <span class="kn">import</span> <span class="n">Sobol</span> <span class="c1"># Only generates real vectors in range 0 to 1 per dimension</span>
        <span class="kn">import</span> <span class="nn">json</span>
        <span class="n">sobol_gen</span> <span class="o">=</span> <span class="n">Sobol</span><span class="p">()</span>
        <span class="n">sobol</span> <span class="o">=</span> <span class="n">sobol_gen</span><span class="o">.</span><span class="n">i4_sobol_generate</span><span class="p">(</span><span class="n">num_dims</span><span class="p">,</span> <span class="n">num_configs</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sobol</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sobol</span><span class="p">:</span>
            <span class="c1"># print(sample)</span>
            <span class="n">sobol_configs</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span> <span class="c1"># new config</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span> <span class="c1"># i.e. a constant value</span>
                    <span class="n">sobol_configs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># The rest are config spaces for param settings</span>
                <span class="k">elif</span> <span class="s2">&quot;int&quot;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">lower</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">upper</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s2">&quot;log&quot;</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">else</span> <span class="kc">False</span>
                    <span class="c1">#TODO log vals</span>
                    <span class="n">sobol_val</span> <span class="o">=</span> <span class="n">lower</span> <span class="o">+</span> <span class="p">(</span><span class="n">upper</span> <span class="o">-</span> <span class="n">lower</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">sobol_configs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sobol_val</span><span class="p">)</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="s2">&quot;float&quot;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">lower</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">upper</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s2">&quot;log&quot;</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">else</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
                        <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span>
                    <span class="n">sobol_val</span> <span class="o">=</span> <span class="n">lower</span> <span class="o">+</span> <span class="p">(</span><span class="n">upper</span> <span class="o">-</span> <span class="n">lower</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                        <span class="n">sobol_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sobol_val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;reward_dist&quot;</span><span class="p">:</span>
                        <span class="n">sobol_val</span> <span class="o">=</span> <span class="p">[</span><span class="n">sobol_val</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
                    <span class="n">sobol_configs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sobol_val</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="s2">&quot;cat&quot;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">choices</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span> <span class="c1"># Seems faster than ast.literal_eval (See https://stackoverflow.com/questions/1894269/how-to-convert-string-representation-of-list-to-a-list)</span>
                    <span class="n">len_c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sample</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span> <span class="c1">#TODO remove? Don&#39;t know if sobol samples include 1.0</span>
                        <span class="n">sample</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">1e-10</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">len_c</span><span class="p">)</span>
                    <span class="n">sobol_configs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># import pprint</span>
        <span class="c1"># pp = pprint.PrettyPrinter(indent=4)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sobol_configs</span><span class="p">):</span>
        <span class="n">sobol_configs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="c1">#hack</span>
        <span class="c1"># print(conf)</span>
        <span class="c1"># pp.pprint(sobol_configs[i])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sobol_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sobol_configs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">sobol_configs</span></div>



<div class="viewcode-block" id="combined_processing"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.combined_processing.html#mdp_playground.config_processor.config_processor.combined_processing">[docs]</a><span class="k">def</span> <span class="nf">combined_processing</span><span class="p">(</span><span class="o">*</span><span class="n">static_configs</span><span class="p">,</span> <span class="n">varying_configs</span><span class="p">,</span> <span class="n">framework</span><span class="o">=</span><span class="s1">&#39;ray&#39;</span><span class="p">,</span>
        <span class="n">algorithm</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    varying_configs is a list of dict of dicts with structure of each element</span>
<span class="sd">    in the list as: {</span>
<span class="sd">        &quot;env&quot;: {...}</span>
<span class="sd">        &quot;agent&quot;: {...}</span>
<span class="sd">        &quot;model&quot;: {...}</span>
<span class="sd">    }</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># print(len(configs))</span>
    <span class="c1"># print(type(configs))</span>
    <span class="c1"># print(type(*configs))</span>

    <span class="c1"># Pre-processing common to frameworks:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">varying_config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">varying_configs</span><span class="p">):</span>

        <span class="c1"># ###IMP This needs to be done before merging because otherwise</span>
        <span class="c1"># varying_config[&quot;env&quot;] clashes with &quot;env&quot; key of Ray Tune config later.</span>
        <span class="n">varying_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;env_config&quot;</span><span class="p">:</span> <span class="n">varying_config</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">],</span> \
                            <span class="o">**</span><span class="n">varying_config</span><span class="p">[</span><span class="s2">&quot;agent&quot;</span><span class="p">],</span> \
                            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">varying_config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]}</span>
        <span class="n">varying_configs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">varying_config</span>


    <span class="c1"># Ray specific pre-processing</span>
    <span class="k">if</span> <span class="n">framework</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ray&#39;</span><span class="p">:</span>
        <span class="o">...</span>


    <span class="c1"># Stable Baselines specific pre-processing</span>
    <span class="k">elif</span> <span class="n">framework</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;stable_baselines&#39;</span><span class="p">:</span>
        <span class="o">...</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Framework passed was not a valid option. It was: &quot;</span> \
            <span class="o">+</span> <span class="n">framework</span> <span class="o">+</span> <span class="s2">&quot;. Available options are: ray and stable_baselines.&quot;</span><span class="p">)</span>


    <span class="c1"># Merge all configs into one</span>
    <span class="n">final_configs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varying_configs</span><span class="p">)):</span>
        <span class="n">static_configs_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">static_configs</span><span class="p">)</span>
        <span class="n">merged_conf</span> <span class="o">=</span> <span class="n">deepmerge_multiple_dicts</span><span class="p">(</span><span class="o">*</span><span class="n">static_configs_copy</span><span class="p">,</span> <span class="n">varying_configs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">final_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merged_conf</span><span class="p">)</span>


    <span class="c1"># Post-processing common to frameworks:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">final_config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">final_configs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mujoco_envs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;time_unit&quot;</span> <span class="ow">in</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">]:</span> <span class="c1"># #hack This is</span>
            <span class="c1"># needed so that the environment runs the same amount of seconds of</span>
            <span class="c1"># simulation, even though episode steps are different.</span>
                <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span> <span class="o">/=</span> \
                    <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">][</span><span class="s2">&quot;time_unit&quot;</span><span class="p">]</span>
                <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;horizon&quot;</span><span class="p">])</span>

                <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;learning_starts&quot;</span><span class="p">]</span> <span class="o">/=</span> \
                    <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">][</span><span class="s2">&quot;time_unit&quot;</span><span class="p">]</span>
                <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;learning_starts&quot;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">int</span><span class="p">(</span><span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;learning_starts&quot;</span><span class="p">])</span>

                <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;timesteps_per_iteration&quot;</span><span class="p">]</span> <span class="o">/=</span> \
                    <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">][</span><span class="s2">&quot;time_unit&quot;</span><span class="p">]</span>
                <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;timesteps_per_iteration&quot;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="nb">int</span><span class="p">(</span><span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;timesteps_per_iteration&quot;</span><span class="p">])</span>

                <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;evaluation_config&quot;</span><span class="p">][</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span> <span class="o">/=</span>\
                    <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">][</span><span class="s2">&quot;time_unit&quot;</span><span class="p">]</span>
                <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;evaluation_config&quot;</span><span class="p">][</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="nb">int</span><span class="p">(</span><span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;evaluation_config&quot;</span><span class="p">][</span><span class="s2">&quot;horizon&quot;</span><span class="p">])</span>

                <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;train_batch_size&quot;</span><span class="p">]</span> <span class="o">*=</span>\
                    <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">][</span><span class="s2">&quot;time_unit&quot;</span><span class="p">]</span> <span class="c1"># this is needed</span>
                    <span class="c1"># because Ray (until version 0.8.6 I think) fixes the</span>
                    <span class="c1"># ratio of number of samples trained/number of steps sampled</span>
                    <span class="c1"># in environment</span>
                <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;train_batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">int</span><span class="p">(</span><span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;train_batch_size&quot;</span><span class="p">])</span>

        <span class="c1"># #hack Common #mujoco wrapper to allow Mujoco envs to be wrapped by</span>
        <span class="c1"># MujocoEnvWrapper (which fiddles with lower-level Mujoco stuff) and</span>
        <span class="c1"># then by GymEnvWrapper which is more general and basically adds</span>
        <span class="c1"># dimensions from MDPP which are common to discrete and continuous</span>
        <span class="c1"># environments</span>

        <span class="c1"># if final_configs[i][&quot;env&quot;] in mujoco_envs:</span>

        <span class="c1"># #default settings for #timesteps_total</span>
        <span class="k">if</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;HalfCheetahWrapper-v3&quot;</span><span class="p">]:</span> <span class="c1">#hack</span>
            <span class="n">timesteps_total</span> <span class="o">=</span> <span class="mi">3000000</span>

            <span class="kn">from</span> <span class="nn">mdp_playground.envs.mujoco_env_wrapper</span> <span class="kn">import</span> <span class="n">get_mujoco_wrapper</span> <span class="c1">#hack</span>
            <span class="kn">from</span> <span class="nn">gym.envs.mujoco.half_cheetah_v3</span> <span class="kn">import</span> <span class="n">HalfCheetahEnv</span>
            <span class="n">wrapped_mujoco_env</span> <span class="o">=</span> <span class="n">get_mujoco_wrapper</span><span class="p">(</span><span class="n">HalfCheetahEnv</span><span class="p">)</span>
            <span class="n">register_env</span><span class="p">(</span><span class="s2">&quot;HalfCheetahWrapper-v3&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">config</span><span class="p">:</span> <span class="n">create_gym_env_wrapper_mujoco_wrapper</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">wrapped_mujoco_env</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;HopperWrapper-v3&quot;</span><span class="p">]:</span> <span class="c1">#hack</span>
            <span class="n">timesteps_total</span> <span class="o">=</span> <span class="mi">1000000</span>

            <span class="kn">from</span> <span class="nn">mdp_playground.envs.mujoco_env_wrapper</span> <span class="kn">import</span> <span class="n">get_mujoco_wrapper</span> <span class="c1">#hack</span>
            <span class="kn">from</span> <span class="nn">gym.envs.mujoco.hopper_v3</span> <span class="kn">import</span> <span class="n">HopperEnv</span>
            <span class="n">wrapped_mujoco_env</span> <span class="o">=</span> <span class="n">get_mujoco_wrapper</span><span class="p">(</span><span class="n">HopperEnv</span><span class="p">)</span>
            <span class="n">register_env</span><span class="p">(</span><span class="s2">&quot;HopperWrapper-v3&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">config</span><span class="p">:</span> <span class="n">create_gym_env_wrapper_mujoco_wrapper</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">wrapped_mujoco_env</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PusherWrapper-v2&quot;</span><span class="p">]:</span> <span class="c1">#hack</span>
            <span class="n">timesteps_total</span> <span class="o">=</span> <span class="mi">500000</span>

            <span class="kn">from</span> <span class="nn">mdp_playground.envs.mujoco_env_wrapper</span> <span class="kn">import</span> <span class="n">get_mujoco_wrapper</span> <span class="c1">#hack</span>
            <span class="kn">from</span> <span class="nn">gym.envs.mujoco.pusher</span> <span class="kn">import</span> <span class="n">PusherEnv</span>
            <span class="n">wrapped_mujoco_env</span> <span class="o">=</span> <span class="n">get_mujoco_wrapper</span><span class="p">(</span><span class="n">PusherEnv</span><span class="p">)</span>
            <span class="n">register_env</span><span class="p">(</span><span class="s2">&quot;PusherWrapper-v2&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">config</span><span class="p">:</span> <span class="n">create_gym_env_wrapper_mujoco_wrapper</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">wrapped_mujoco_env</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ReacherWrapper-v2&quot;</span><span class="p">]:</span> <span class="c1">#hack</span>
            <span class="n">timesteps_total</span> <span class="o">=</span> <span class="mi">500000</span>

            <span class="kn">from</span> <span class="nn">mdp_playground.envs.mujoco_env_wrapper</span> <span class="kn">import</span> <span class="n">get_mujoco_wrapper</span> <span class="c1">#hack</span>
            <span class="kn">from</span> <span class="nn">gym.envs.mujoco.reacher</span> <span class="kn">import</span> <span class="n">ReacherEnv</span>
            <span class="n">wrapped_mujoco_env</span> <span class="o">=</span> <span class="n">get_mujoco_wrapper</span><span class="p">(</span><span class="n">ReacherEnv</span><span class="p">)</span>
            <span class="n">register_env</span><span class="p">(</span><span class="s2">&quot;ReacherWrapper-v2&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">config</span><span class="p">:</span> <span class="n">create_gym_env_wrapper_mujoco_wrapper</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">wrapped_mujoco_env</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GymEnvWrapper-Atari&quot;</span><span class="p">]:</span> <span class="c1">#hack</span>
            <span class="k">if</span> <span class="s2">&quot;AtariEnv&quot;</span> <span class="ow">in</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">]:</span>
                <span class="n">timesteps_total</span> <span class="o">=</span> <span class="mi">10_000_000</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;DQN&#39;</span><span class="p">:</span>
                <span class="n">timesteps_total</span> <span class="o">=</span> <span class="mi">20000</span>
            <span class="k">elif</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;A3C&#39;</span><span class="p">:</span> <span class="c1">#hack</span>
                <span class="n">timesteps_total</span> <span class="o">=</span> <span class="mi">150000</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#if algorithm == &#39;DDPG&#39;: #hack</span>
                <span class="n">timesteps_total</span> <span class="o">=</span> <span class="mi">20000</span>

        <span class="k">if</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mujoco_envs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;time_unit&quot;</span> <span class="ow">in</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">]:</span> <span class="c1">#hack This is needed so that the environment runs the same amount of seconds of simulation, even though episode steps are different.</span>
                <span class="n">timesteps_total</span> <span class="o">/=</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">][</span><span class="s2">&quot;time_unit&quot;</span><span class="p">]</span>
                <span class="n">timesteps_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timesteps_total</span><span class="p">)</span>


        <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;timesteps_total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timesteps_total</span>

    <span class="c1"># Post-processing for Ray:</span>
    <span class="k">if</span> <span class="n">framework</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ray&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">final_configs</span><span class="p">)):</span>
            <span class="c1"># for config_type in varying_config:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;SAC&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;critic_learning_rate&#39;</span><span class="p">:</span> <span class="c1">#hack</span>
                        <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;optimization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                                    <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                                                    <span class="s1">&#39;actor_learning_rate&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                                                    <span class="s1">&#39;entropy_learning_rate&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                                                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fcnet_hiddens&#39;</span><span class="p">:</span> <span class="c1">#hack</span>
                        <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;Q_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                                <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                                                <span class="s2">&quot;fcnet_activation&quot;</span><span class="p">:</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>
                                                <span class="p">}</span>
                        <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;policy_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                                <span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                                                <span class="s2">&quot;fcnet_activation&quot;</span><span class="p">:</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>
                                                <span class="p">}</span>

                    <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;DDPG&#39;</span><span class="p">:</span> <span class="c1">###TODO Find a better way to enforce these?? Especially problematic for TD3 because then more values for target_noise_clip are witten to CSVs than actually used during HPO but for normal (non-HPO) runs this needs to be not done.</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;critic_lr&quot;</span><span class="p">:</span>
                            <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;actor_lr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;critic_hiddens&quot;</span><span class="p">:</span>
                            <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;actor_hiddens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;TD3&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;target_noise_clip_relative&quot;</span><span class="p">:</span>
                            <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;target_noise_clip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;target_noise_clip_relative&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;target_noise&quot;</span><span class="p">]</span>
                            <span class="k">del</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;target_noise_clip_relative&quot;</span><span class="p">]</span> <span class="c1">#hack have to delete it otherwise Ray will crash for unknown config param.</span>

                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;model&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key_2</span> <span class="ow">in</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">key_2</span> <span class="o">==</span> <span class="s2">&quot;use_lstm&quot;</span><span class="p">:</span>
                            <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;max_seq_len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">][</span><span class="s2">&quot;delay&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">final_configs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;env_config&quot;</span><span class="p">][</span><span class="s2">&quot;sequence_length&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>


    <span class="c1"># Post-processing for Stable Baselines:</span>
    <span class="k">elif</span> <span class="n">framework</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;stable_baselines&#39;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">return</span> <span class="n">final_configs</span></div>


<div class="viewcode-block" id="create_gym_env_wrapper_mujoco_wrapper"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.create_gym_env_wrapper_mujoco_wrapper.html#mdp_playground.config_processor.config_processor.create_gym_env_wrapper_mujoco_wrapper">[docs]</a><span class="k">def</span> <span class="nf">create_gym_env_wrapper_mujoco_wrapper</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">wrapped_mujoco_env</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Creates a GymEnvWrapper around a MujocoEnvWrapper</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">mdp_playground.envs.gym_env_wrapper</span> <span class="kn">import</span> <span class="n">GymEnvWrapper</span>
    <span class="n">me</span> <span class="o">=</span> <span class="n">wrapped_mujoco_env</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="n">gew</span> <span class="o">=</span> <span class="n">GymEnvWrapper</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span> <span class="c1">##IMP Had initially thought to put this config in config[&quot;GymEnvWrapper&quot;] but because of code below which converts var_env_configs to env_config, it&#39;s best to leave those configs as top level configs in the dict!</span>
    <span class="k">return</span> <span class="n">gew</span></div>


<div class="viewcode-block" id="deepmerge_multiple_dicts"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.deepmerge_multiple_dicts.html#mdp_playground.config_processor.config_processor.deepmerge_multiple_dicts">[docs]</a><span class="k">def</span> <span class="nf">deepmerge_multiple_dicts</span><span class="p">(</span><span class="o">*</span><span class="n">configs</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">merged_configs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">configs</span><span class="p">)):</span>
        <span class="c1"># print(i)</span>
        <span class="n">merged_configs</span> <span class="o">=</span> <span class="n">deepmerge</span><span class="p">(</span><span class="n">merged_configs</span><span class="p">,</span> <span class="n">configs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">merged_configs</span></div>


<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<div class="viewcode-block" id="deepmerge"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.deepmerge.html#mdp_playground.config_processor.config_processor.deepmerge">[docs]</a><span class="k">def</span> <span class="nf">deepmerge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Merges dict b into dict a</span>

<span class="sd">    overwrite : bool</span>
<span class="sd">        Overwrites value in a with value in b if True with a warning, else raises Exception</span>

<span class="sd">    Based on: https://stackoverflow.com/questions/7204805/how-to-merge-dictionaries-of-dictionaries/7205107#7205107</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">deepmerge</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="n">a</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">pass</span> <span class="c1"># same leaf value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Overwrote value &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; with &quot;</span> \
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; while merging dicts.&quot;</span><span class="p">)</span>
                    <span class="n">a</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Conflict at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span>\
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; conflicts with &quot;</span> \
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; while merging dicts.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">a</span></div>


<div class="viewcode-block" id="post_processing"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.post_processing.html#mdp_playground.config_processor.config_processor.post_processing">[docs]</a><span class="k">def</span> <span class="nf">post_processing</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="s1">&#39;ray&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">framework</span><span class="o">==</span><span class="s1">&#39;ray&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ray</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_gym_env_wrapper_atari"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.create_gym_env_wrapper_atari.html#mdp_playground.config_processor.config_processor.create_gym_env_wrapper_atari">[docs]</a><span class="k">def</span> <span class="nf">create_gym_env_wrapper_atari</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">gym.envs.atari</span> <span class="kn">import</span> <span class="n">AtariEnv</span>
    <span class="kn">from</span> <span class="nn">mdp_playground.envs.gym_env_wrapper</span> <span class="kn">import</span> <span class="n">GymEnvWrapper</span>
    <span class="n">ae</span> <span class="o">=</span> <span class="n">AtariEnv</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;AtariEnv&quot;</span><span class="p">])</span>
    <span class="n">gew</span> <span class="o">=</span> <span class="n">GymEnvWrapper</span><span class="p">(</span><span class="n">ae</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span> <span class="c1">##IMP Had initially thought to put this config in config[&quot;GymEnvWrapper&quot;] but because of code below which converts var_env_configs to env_config, it&#39;s best to leave those configs as top level configs in the dict!</span>
    <span class="k">return</span> <span class="n">gew</span></div>


<div class="viewcode-block" id="create_gym_env_wrapper_frame_stack_atari"><a class="viewcode-back" href="../../../_autosummary/mdp_playground.config_processor.config_processor.create_gym_env_wrapper_frame_stack_atari.html#mdp_playground.config_processor.config_processor.create_gym_env_wrapper_frame_stack_atari">[docs]</a><span class="k">def</span> <span class="nf">create_gym_env_wrapper_frame_stack_atari</span><span class="p">(</span><span class="n">config</span><span class="p">):</span> <span class="c1">#hack ###TODO remove?</span>
    <span class="sd">&#39;&#39;&#39;When using frameStack GymEnvWrapper should wrap AtariEnv using wrap_deepmind_ray and therefore this function sets &quot;wrap_deepmind_ray&quot;: True and &#39;frame_skip&#39;: 1 inside config so as to keep config same as for create_gym_env_wrapper_atari above and reduce manual errors when switching between the 2.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;wrap_deepmind_ray&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#hack</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;frame_skip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#hack</span>
    <span class="kn">from</span> <span class="nn">gym.envs.atari</span> <span class="kn">import</span> <span class="n">AtariEnv</span>
    <span class="kn">from</span> <span class="nn">mdp_playground.envs.gym_env_wrapper</span> <span class="kn">import</span> <span class="n">GymEnvWrapper</span>
    <span class="kn">import</span> <span class="nn">gym</span>
    <span class="n">game</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;AtariEnv&quot;</span><span class="p">][</span><span class="s2">&quot;game&quot;</span><span class="p">]</span>
    <span class="n">game</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">game</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)])</span>
    <span class="n">ae</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">NoFrameskip-v4&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">game</span><span class="p">))</span>
    <span class="n">gew</span> <span class="o">=</span> <span class="n">GymEnvWrapper</span><span class="p">(</span><span class="n">ae</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span> <span class="c1">##IMP Had initially thought to put this config in config[&quot;GymEnvWrapper&quot;] but because of code below which converts var_env_configs to env_config, it&#39;s best to leave those configs as top level configs in the dict!</span>
    <span class="k">return</span> <span class="n">gew</span></div>

<span class="n">register_env</span><span class="p">(</span><span class="s2">&quot;RLToy-v0&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">config</span><span class="p">:</span> <span class="n">RLToyEnv</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">))</span>
<span class="n">register_env</span><span class="p">(</span><span class="s2">&quot;GymEnvWrapper-Atari&quot;</span><span class="p">,</span> \
            <span class="k">lambda</span> <span class="n">config</span><span class="p">:</span> <span class="n">create_gym_env_wrapper_atari</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
<span class="n">register_env</span><span class="p">(</span><span class="s2">&quot;GymEnvWrapperFrameStack-Atari&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">config</span><span class="p">:</span> <span class="n">create_gym_env_wrapper_frame_stack_atari</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</pre></div>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By MDP Playground developers<br/>
        
            &copy; Copyright 2021, MDP Playground developers.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>